{% import "macros/planet.html" as planet_macros %}
{% import "macros/identity.html" as id_macros %}

{% macro oneup(star) %}
<button class="oneup btn btn-xs {% if star.oneupped() %}btn-inverse{% else %}btn-default{% endif %} oneup-{{star.id}}" data-id="{{star.id}}" type="button">
  <span class="oneup-count oneup-count-{{star.id}}">{{star.oneup_count()}}</span> <i class="fa fa-white fa-arrow-up"></i>
</button>
{% endmacro %}


{% macro repost_button(star, btn="btn-primary") %}
  <span data-toggle="modal" data-star-text="Repost: {{star.text}}" data-star-id="{{star.id}}" data-target="#rk-repost">
    <button class="btn {{btn}}" data-toggle="tooltip" data-placement="bottom" title="Share this Star with People, Movements or anywhere else!">
      <i class="fa fa-retweet"></i> Repost
    </button>
  </span>
{% endmacro %}

{% macro comments_button(star) %}
<span>
    <a class="btn btn-xs btn-default" href="{{ url_for('web.star', id=star.id, _anchor='comments') }}">
        <span class="oneup-count" id="comment-count-{{star.id}}">{{star.comment_count()}}</span> <i class="fa fa-white fa-comment"></i>
    </a>
</span>
{% endmacro %}

{% macro promote_button(star, movement) %}
{% if movement.current_role() == "admin" %}
<span>
    <button class="btn btn-xs btn-default rk-promote" href="#" data-loading-text='<i class="fa fa-circle-o-notch fa-spin"></i> Promote' data-star-id="{{ star.id }}" data-promote-url="{{ url_for('web.async_promote', movement_id=movement.id) }}">Promote</button>
</span>
{% endif %}
{% endmacro %}

{% macro label_badges(labels) %}
    {% if labels %}
      {% for label in labels %}
          {% if not label.kind %}
              {% set kind = "default" %}
          {% else %}
              {% set kind = label.kind %}
          {% endif %}
          <span class="label label-{{kind}}">{{ label.text }}</span>
      {% endfor %}
    {% endif %}
{% endmacro %}


{% macro star_lead(star, controlled_personas, truncate=True, promote_to=None, labels=None) %}

<!-- STAR {{star.id}} -->
<div class="rk-star rk-star-lead rk-star-{{ star.id }}">
  <span class="rk-star-title">
    <h2>
      {{ label_badges(labels) }}
      <a href="{{ url_for('web.star', id=star.id) }}">{{ star.text|mentions(star, nolink=True) }}</a>
    </h2>
  </span>

  <!-- Attachments -->
  <div class="rk-planet">
    <div class="row">
    {% for planet_assoc in star.planet_assocs|sort(attribute='sort_rank') %}
      {% if planet_assoc.planet.kind == "linkedpicture" %}
      <div class="col-sm-4">
        {{ planet_macros.planet(planet_assoc.planet, scale=True, icon=True)}}
      </div>
      {% elif planet_assoc.planet.kind == 'tag' %}
        {{ planet_macros.planet(planet_assoc.planet, scale=True, icon=True)}}
      {% else %}
      <div class="col-sm-12">
        {{ planet_macros.planet(planet_assoc.planet, scale=True, icon=True, truncate=truncate)}}
      </div>
      {% endif %}
    {% endfor %}
    </div>
  </div>

  <!-- Meta -->
  <div class="rk-star-meta">
    {{ oneup(star) }}

    {{ comments_button(star) }}

    {% if promote_to != None %}
      {{ promote_button(star, movement=promote_to) }}
    {% endif %}

    <span>
        <span class="caption">
            {{star.created|localtime|naturaltime}}
        </span>
    </span>

    <span class="inline-semantic"> by </span>

    <span class="attribute">
        <span class="caption">
            {{ id_macros.identity(star.author) }}
        </span>
    </span>
  </div>
</div>
{% endmacro %}



{% macro star_line(star, controlled_personas, truncate=True, no_planets=False, promote_to=None, labels=None) %}

<!-- STAR {{star.id}} -->
<div class="rk-star rk-star-line rk-star-{{ star.id }} clearfix">
  <!-- Meta -->
  <span class="rk-star-meta">
    {{ oneup(star) }}
    {{ comments_button(star) }}

    {% if promote_to != None %}
      {{ promote_button(star, movement=promote_to) }}
    {% endif %}
  </span>

  <div class="rk-line-container">
    <div class="rk-star-title">
      <p>
      {{ label_badges(labels) }}
      <a href="{{ url_for('web.star', id=star.id) }}">{{ star.text|mentions(star, nolink=True) }}</a>
      {% if no_planets %}
      {% for planet_assoc in star.planet_assocs %}{{ planet_macros.planet_icon(planet_assoc.planet)}}{% endfor %}
      {% endif %}
      </p>
    </div>

    {% if no_planets == False and star.planet_assocs.count() > 0 %}
    <!-- Attachments -->
    <div class="rk-planet">
      <div class="row">
      {% for planet_assoc in star.planet_assocs|sort(attribute='sort_rank') %}
        {% if planet_assoc.planet.kind == "linkedpicture" %}
        <div class="col-sm-4">
          {{ planet_macros.planet(planet_assoc.planet, scale=True, icon=True)}}
        </div>
        {% elif planet_assoc.planet.kind == 'tag' %}
          {{ planet_macros.planet(planet_assoc.planet, scale=True, icon=True)}}
        {% else %}
        <div class="col-sm-12">
          {{ planet_macros.planet(planet_assoc.planet, scale=True, icon=True, truncate=truncate)}}
        </div>
        {% endif %}
      {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endmacro %}



{% macro star_box(star, controlled_personas) %}

<!-- STAR {{star.id}} -->
<div class="rk-star rk-star-box col-md-3 rk-star-{{ star.id }}">
  <div class="panel">
    <a href="{{ url_for('web.star', id=star.id) }}">
      <div class="rk-star-box-content">
        <p>{{ star.text|mentions(star, nolink=True) }}</p>
        <div class="rk-star-box-planets">{% for planet_assoc in star.planet_assocs|sort(attribute='sort_rank') %}
        {{ planet_macros.planet_icon(planet_assoc.planet)}}
        {% endfor %}</div>
      </div>
    </a>
  </div>
  <p>
    {{ oneup(star) }}

    <span class="caption">
        <a href="{{ url_for('web.star', id=star.id) }}" title="{{star.created}}">
        <i class="fa fa-star"></i> {{star.created|localtime|naturaltime}}</a>
    </span>
  </p>
</div>
{% endmacro %}


{% macro short(star) %}
  <a href="{{ url_for('web.star', id=star.id) }}">{{star.author.username}}: {{star.text|mentions(star, nolink=True)}}</a>
{% endmacro %}



{% macro comment(star, controlled_personas, no_planets=False, truncate=True) %}
<!-- STAR {{star.id}} -->
<div class="rk-star rk-star-line rk-star-{{ star.id }} clearfix">
  <!-- Meta -->
  <span class="rk-star-meta">
    {{ oneup(star) }}
  </span>

  <div class="rk-line-container">
    <div class="rk-star-meta">
      <span class="small">
        {{ id_macros.identity(star.author) }}
        {% if star.starmap and star.starmap != star.parent.starmap %}
        on <a href="{{ star.starmap.get_absolute_url() }}"><span class="label label-default">{{ star.starmap.name }}</span></a>
        {% endif %}
        {{ star.created|localtime|naturaltime }}
        <a href="{{ url_for('web.star', id=star.id) }}">link</a>
      </span>
    </div>

    <div class="rk-star-title">
      <p>{{ star.text|mentions(star) }}</p>
      {% if no_planets %}
      {% for planet_assoc in star.planet_assocs %}{{ planet_macros.planet_icon(planet_assoc.planet)}}{% endfor %}
      {% endif %}
    </div>

    {% if no_planets == False and star.planet_assocs.count() > 0 %}
    <!-- Attachments -->
    <div class="rk-planet">
      <div class="row">
      {% for planet_assoc in star.planet_assocs|sort(attribute='sort_rank') %}
        {% if planet_assoc.planet.kind == "linkedpicture" %}
        <div class="col-sm-4">
          {{ planet_macros.planet(planet_assoc.planet, scale=True, icon=True)}}
        </div>
        {% elif planet_assoc.planet.kind == 'tag' %}
          {{ planet_macros.planet(planet_assoc.planet, scale=True, icon=True)}}
        {% else %}
        <div class="col-sm-12">
          {{ planet_macros.planet(planet_assoc.planet, scale=True, icon=True, truncate=truncate)}}
        </div>
        {% endif %}
      {% endfor %}
      </div>
    </div>
    {% endif %}

    <div class="rk-star-meta">
      <small><a href="{{ url_for('web.create_star', parent=star.id, starmap=star.starmap.id) }}" class="rk-create-display-toggle" data-id="{{ star.id }}">reply</a></small>
      <form class="rk-create" action="{{ url_for('web.create_star') }}" method="GET">
        <input class="rk-create-parent" name="parent" type="hidden" value="{{ star.id }}">
        <input type="hidden" name="starmap" value="{{ star.starmap_id }}" />
        <div>
          <span>&nbsp;</span>
          <div class="pull-right rk-create-counter"></div>
          <div class="rk-create-extend">
            <p>That's a lot of text! Do you want to make a long post? <input type="submit" class="btn btn-sm btn-primary" value="Yes, please"></p>
          </div>
        </div>
        <div class="form-group">
          <textarea class="form-control rk-create-text" name="text"></textarea>
        </div>
        <button type="submit" class="rk-create-submit btn btn-sm btn-default" class="btn btn-default btn-sm" data-loading-text='<i class="fa fa-circle-o-notch fa-spin"></i>'>Reply</button>
      </form>
    </div>
  </div>

</div>
{% endmacro %}



{% macro comment_tree(star, controlled_personas, deep=3, truncate=True) %}

{{ comment(star, controlled_personas, truncate=truncate) }}

{% if deep > 0 %}
  {% set new_deep=(deep-1) %}
  <div class="rk-replies clearfix">
    {% for c in star.comments %}
      {% if c.context_length > 0 %}
      {{ comment_tree(c, controlled_personas, deep=new_deep) }}
      {% else %}
      <small>[<a href="{{ url_for('web.star', id=c.id) }}">Reply
      was hidden from this context by the author</a>]</small>
      {% endif %}
    {% endfor %}
  </div>
{% endif %}

{% endmacro %}
